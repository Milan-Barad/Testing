{% liquid
  assign enable_rtl = settings.enable_rtl
  assign language_support_rtl = settings.language_support_rtl
  if enable_rtl and language_support_rtl != blank
    assign shop_locale = localization.language.iso_code
    assign language_support_rtl_list = language_support_rtl | split: ','
    assign is_rtl = language_support_rtl_list | where: shop_locale
    if is_rtl.size > 0
      assign enable_rtl = true
    else
      assign enable_rtl = false
    endif
  endif

  assign body_classes = 'template-' | append: template.name | append: ' ' | append: template.suffix | append: ' m-gradient m-color-' | append: settings.default_color_scheme
  if settings.page_transition
    assign body_classes = body_classes | append: ' m:overflow-hidden'
  endif
  if template.suffix == 'about-us'
    assign body_classes = body_classes | append: ' sf__page-about'
  endif
%}
<!doctype html>
<html
  class="no-js {% if settings.page_transition %} m:overflow-hidden{% endif %}"
  lang="{{ request.locale.iso_code }}"
  data-template="{{ template.name }}"
  {% if enable_rtl %}
    dir="rtl"
  {% endif %}
>
  <head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KXW483Q6');</script>
    <!-- End Google Tag Manager -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=0">
    <meta name="theme-color" content="{{ settings.color_primary }}">
    <link rel="canonical" href="{{ canonical_url }}">
    <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
    <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>

    {%- if settings.use_favicon == true and settings.favicon != blank -%}
      <link rel="shortcut icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">
    {%- endif -%}

    <title>
      {{- page_title -}}
      {%- if current_tags -%}
        {%- assign meta_tags = current_tags | join: ', ' %} &ndash; {{ 'general.meta.tags' | t: tags: meta_tags -}}
      {%- endif -%}
      {%- if current_page != 1 %} &ndash; {{ 'general.meta.page' | t: page: current_page }}{% endif -%}
      {%- if template == 'password' -%}
        {{- shop.name -}}
      {%- else -%}
        {%- unless page_title contains shop.name %} &ndash; {{ shop.name }}{% endunless -%}
      {%- endif -%}
    </title>

    {%- if page_description -%}
      <meta name="description" content="{{ page_description | escape }}">
    {%- endif -%}

    {%- liquid
      render 'social-meta-tags'
      render 'font-face'
      render 'critical-css'

      echo 'main.css' | asset_url | stylesheet_tag: preload: true

      render 'style-tags'
    -%}

    <script src="{{ 'vendor.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'theme-global.js' | asset_url }}" defer="defer"></script>
    {%- if settings.animations != 'none' -%}
      <script src="{{ 'animations.js' | asset_url }}" defer="defer"></script>
    {%- endif -%}
    {%- if request.design_mode -%}
      <script src="{{ 'theme-editor.js' | asset_url }}" defer="defer"></script>
    {%- endif -%}

    {%- render 'header-scripts.zipifypages', renderctx: 'thm', apprxhbl: zp_apprxhbl -%}{{ content_for_header }}

    <script>
      document.documentElement.className = document.documentElement.className.replace('no-js', 'js');
      if (Shopify.designMode) {
        document.documentElement.classList.add('shopify-design-mode');
      }
    </script>
    {% render 'theme-data' %}
    {% render 'custom-code-head' %}
  {% include 'pagefly-app-header' %}</head>

  <!-- Google tag (gtag.js) -->
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KHL9F4RW56"></script>
<script>
  (function() {
    // Initialize dataLayer if not already defined
    window.dataLayer = window.dataLayer || [];

    // Function to push add_to_cart event to dataLayer
    function onAddToCart(product) {
      try {
        window.dataLayer.push({
          event: 'add_to_cart',
          ecommerce: {
            currency: product.currency || 'USD', // Fallback currency
            value: parseFloat(product.price) || 0, // Ensure price is a number
            items: [{
              item_id: product.id || 'unknown', // Fallback ID
              item_name: product.name || 'Unknown Product', // Fallback name
              price: parseFloat(product.price) || 0, // Ensure price is a number
              quantity: parseInt(product.quantity, 10) || 1 // Ensure quantity is an integer
            }]
          }
        });
        console.log('Add to Cart event pushed:', window.dataLayer[window.dataLayer.length - 1]);
      } catch (error) {
        console.error('Error pushing add_to_cart event:', error);
      }
    }

    // Function to push purchase event to dataLayer
    function onPurchase(order) {
      try {
        window.dataLayer.push({
          event: 'purchase',
          ecommerce: {
            transaction_id: order.transaction_id || 'unknown', // Unique transaction ID
            value: parseFloat(order.value) || 0, // Total order value
            currency: order.currency || 'USD', // Currency
            tax: parseFloat(order.tax) || 0, // Tax amount
            shipping: parseFloat(order.shipping) || 0, // Shipping cost
            items: order.items.map(item => ({
              item_id: item.id || 'unknown', // Item ID
              item_name: item.name || 'Unknown Product', // Item name
              price: parseFloat(item.price) || 0, // Item price
              quantity: parseInt(item.quantity, 10) || 1 // Item quantity
            }))
          }
        });
        console.log('Purchase event pushed:', window.dataLayer[window.dataLayer.length - 1]);
      } catch (error) {
        console.error('Error pushing purchase event:', error);
      }
    }

    // Example: Attach event listener to Add to Cart button
    document.addEventListener('click', function(event) {
      if (event.target.closest('.add-to-cart-button')) {
        var product = {
          id: '12345', // Replace with dynamic product ID
          name: 'Sample Product', // Replace with dynamic product name
          price: 29.99, // Replace with dynamic product price
          quantity: 1, // Replace with dynamic quantity
          currency: 'USD' // Replace with dynamic currency
        };
        onAddToCart(product);
      }
    });

    // Example: Attach event listener for payment completion (e.g., on a "Confirm Purchase" button)
    document.addEventListener('click', function(event) {
      if (event.target.closest('.confirm-purchase-button')) {
        var order = {
          transaction_id: 'TXN-' + Date.now(), // Replace with dynamic transaction ID
          value: 59.98, // Replace with dynamic total order value
          currency: 'USD', // Replace with dynamic currency
          tax: 4.99, // Replace with dynamic tax amount
          shipping: 5.00, // Replace with dynamic shipping cost
          items: [
            {
              id: '12345', // Replace with dynamic product ID
              name: 'Sample Product', // Replace with dynamic product name
              price: 29.99, // Replace with dynamic product price
              quantity: 2 // Replace with dynamic quantity
            }
          ]
        };
        onPurchase(order);
      }
    });
  })();
</script>

  <body
    id="m-theme"
    class="{{ body_classes }}"
    {% if template.name == 'product' %}
      data-product-id="{{ product.id }}"
    {% endif %}
  >
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KXW483Q6"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    {%- liquid
      render 'page-transition'
      render 'scroll-top-button'
      sections 'header-group'
    -%}

    <main role="main" id="MainContent">
      {{ content_for_layout }}
    </main>

    {%- liquid
      sections 'footer-group'
      render 'script-tags'
      render 'cookie-banner'
      render 'custom-code-body'
    -%}

    <script src="{{ 'product-quick-view.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'wishlist.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'compare-product.js' | asset_url }}" defer="defer"></script>

    {%- if settings.enable_predictive_search -%}
      <script src="{{ 'predictive-search.js' | asset_url }}" defer="defer"></script>
    {%- endif -%}

    {%- if linklists['gift-wrapping'].links != blank
      and linklists['gift-wrapping'].links.first.type == 'product_link'
    -%}
      <script src="{{ 'gift-wrapping.js' | asset_url }}" defer="defer"></script>
    {%- endif -%}

    {%- if settings.show_swatch_option -%}
      <script src="{{ 'product-card-swatch.js' | asset_url }}" defer="defer"></script>
    {%- endif -%}

    {%- if settings.enable_cart_drawer and template != 'cart' -%}
      {% render 'cart-drawer' %}
    {%- endif -%}
  {%- render 'page-footer.zipifypages', renderctx: 'thm', ocuapp: oneclickupsellapp -%}</body>
</html>
